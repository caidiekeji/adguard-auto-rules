name: AdGuard Rules Auto-Update
on:
  schedule:
    - cron: '0 10 * * *'  # æ¯å¤©UTCæ—¶é—´10ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´18ç‚¹ï¼‰è¿è¡Œ
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

env:
  MAX_RETRY: 3
  MIN_RULES: 100000  # é™ä½é˜ˆå€¼ä»¥æé«˜æˆåŠŸç‡

jobs:
  rule-updater:
    name: Update AdBlock Rules
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ========== åˆå§‹åŒ–é˜¶æ®µ ==========
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}

      # ========== è§„åˆ™ä¸‹è½½é˜¶æ®µ ==========
      - name: Download all rule sources
        id: download
        continue-on-error: true  # å…è®¸éƒ¨åˆ†ä¸‹è½½å¤±è´¥
        run: |
          set -eo pipefail
          mkdir -p ./tmp
          
          declare -A RULE_SOURCES=(
            # å›½å†…è§„åˆ™
            ["anti-ad"]="https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/master/anti-ad-easylist.txt"
            ["adbyby-video"]="https://raw.githubusercontent.com/adbyby/xwhyc-rules/master/video.txt"
            ["xinggsf"]="https://gitee.com/xinggsf/Adblock-Rule/raw/master/rule.txt"
            ["blueskyxn"]="https://raw.githubusercontent.com/BlueSkyXN/AdGuardHomeRules/master/all.txt"
            
            # å›½é™…è§„åˆ™
            ["easylist-china"]="https://easylist-downloads.adblockplus.org/easylistchina.txt"
            ["adguard-base"]="https://filters.adtidy.org/extension/ublock/filters/2.txt"
            ["oisd"]="https://dbl.oisd.nl/"
            ["nocoin"]="https://raw.githubusercontent.com/hoshsadiq/adblock-nocoin-list/master/nocoin.txt"
          )

          # å¹¶è¡Œä¸‹è½½æ‰€æœ‰è§„åˆ™
          for name in "${!RULE_SOURCES[@]}"; do
            (
              echo "â†’ ä¸‹è½½ $name è§„åˆ™..."
              curl --retry $MAX_RETRY --connect-timeout 30 -sSL \
                "${RULE_SOURCES[$name]}" -o "./tmp/${name}.txt" 2>&1 || {
                  echo "::warning::ä¸‹è½½å¤±è´¥: $name"
                  exit 0
                }
              
              # éªŒè¯æ–‡ä»¶æœ‰æ•ˆæ€§
              if [[ ! -s "./tmp/${name}.txt" ]]; then
                echo "::warning::ç©ºæ–‡ä»¶: $name"
                rm -f "./tmp/${name}.txt"
              fi
            ) &
          done
          wait

          echo "downloaded_files=$(ls ./tmp/*.txt 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          echo "failed_downloads=$((${#RULE_SOURCES[@]} - $(ls ./tmp/*.txt 2>/dev/null | wc -l)))" >> $GITHUB_OUTPUT

      # ========== è§„åˆ™å¤„ç†é˜¶æ®µ ==========  
      - name: Process and merge rules
        id: process
        run: |
          set -eo pipefail
          
          # 1. ç”Ÿæˆæ ‡å‡†æ–‡ä»¶å¤´
          cat <<-'EOF' > adguard-rules.txt
          ! Title: Ultimate AdGuard Rules
          ! Description: èšåˆå¹¿å‘Šè¿‡æ»¤è§„åˆ™ | å«è§†é¢‘/éšç§/å›½é™…è§„åˆ™
          ! Expires: 1 day
          ! Version: $(date +%Y%m%d)
          ! Homepage: https://github.com/${{ github.repository }}
          ! License: MIT
          ! Last modified: $(date -u '+%Y-%m-%dT%H:%M:%SZ')
          !
          ! åŒ…å«è§„åˆ™æº:
          EOF
          
          # 2. æ·»åŠ è§„åˆ™æºä¿¡æ¯
          for file in ./tmp/*.txt 2>/dev/null; do
            echo "! - $(basename "${file%.*}")" >> adguard-rules.txt
          done
          echo "!" >> adguard-rules.txt

          # 3. åˆ†ç±»åˆå¹¶è§„åˆ™
          {
            # åŸºç¡€å¹¿å‘Šè§„åˆ™
            grep -hE '^\|\|.*\^|^@@\|\|' ./tmp/{anti-ad,adguard-base,easylist-china}.txt 2>/dev/null || true
            
            # è§†é¢‘ä¸“é¡¹è§„åˆ™
            grep -hE '^\|\|.*(video|tv|stream)' ./tmp/{adbyby-video,xinggsf}.txt 2>/dev/null || true
            
            # éšç§ä¿æŠ¤è§„åˆ™
            grep -h '^\|\|' ./tmp/{nocoin,oisd,blueskyxn}.txt 2>/dev/null | grep -Ev '^!' || true
            
            # ç™½åå•è§„åˆ™
            grep -h '^@@|' ./tmp/*.txt 2>/dev/null | sort -u || true
          } | awk '!x[$0]++' | grep -vE '^$|^#' >> adguard-rules.txt

          # 4. ç»Ÿè®¡ä¿¡æ¯
          total_rules=$(grep -c '^\|\|' adguard-rules.txt)
          echo "total_rules=$total_rules" >> $GITHUB_OUTPUT
          echo "! æ€»è§„åˆ™æ•°: $total_rules" >> adguard-rules.txt
          echo "! æœ€åæ›´æ–°: $(date +'%Y-%m-%d %H:%M:%S')" >> adguard-rules.txt

      # ========== éªŒè¯é˜¶æ®µ ==========
      - name: Validate rules
        id: validate
        run: |
          # åŸºç¡€æ£€æŸ¥
          if [[ ! -s adguard-rules.txt ]]; then
            echo "::error::ç”Ÿæˆæ–‡ä»¶ä¸ºç©º!"
            exit 1
          fi

          # è§„åˆ™æ•°é‡éªŒè¯
          total_rules=$(grep -c '^\|\|' adguard-rules.txt)
          if (( total_rules < MIN_RULES )); then
            echo "::error::è§„åˆ™æ•°ä¸è¶³! å½“å‰: $total_rules (æœ€ä½è¦æ±‚: $MIN_RULES)"
            exit 1
          fi

          # å…³é”®è§„åˆ™æ£€æŸ¥
          declare -A REQUIRED_PATTERNS=(
            ["è§†é¢‘è§„åˆ™"]="video|tv|stream"
            ["è·Ÿè¸ªä¿æŠ¤"]="analytics|track"
          )
          
          for desc in "${!REQUIRED_PATTERNS[@]}"; do
            count=$(grep -cE "${REQUIRED_PATTERNS[$desc]}" adguard-rules.txt)
            if (( count < 50 )); then
              echo "::warning::${desc}æ•°é‡å¯èƒ½ä¸è¶³: $count"
            fi
          done

      # ========== æäº¤é˜¶æ®µ ==========
      - name: Commit changes
        if: steps.validate.outcome == 'success'
        continue-on-error: true
        run: |
          git config --global user.name "AdGuard Updater"
          git config --global user.email "updater@noreply.github.com"
          
          git add adguard-rules.txt
          if git diff --cached --quiet; then
            echo "::notice::æ— æ–°å˜æ›´"
          else
            git commit -m "Update: $(date +'%m-%d') [$((${{ steps.process.outputs.total_rules }} / 1000))k rules]"
            if ! git push; then
              echo "::warning::é¦–æ¬¡æ¨é€å¤±è´¥ï¼Œå°è¯•æ‹‰å–æœ€æ–°å˜æ›´..."
              git pull --rebase
              git push
            fi
          fi

      # ========== æŠ¥å‘Šç”Ÿæˆ ==========
      - name: Generate report
        if: always()
        run: |
          echo "### ğŸ›¡ï¸ AdGuard è§„åˆ™æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "| æŒ‡æ ‡ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----|" >> $GITHUB_STEP_SUMMARY
          echo "| å°è¯•ä¸‹è½½ | ${{ env.MIN_RULES }} æ¡ |" >> $GITHUB_STEP_SUMMARY
          echo "| æˆåŠŸä¸‹è½½ | ${{ steps.download.outputs.downloaded_files || 0 }} ä¸ªæº |" >> $GITHUB_STEP_SUMMARY
          echo "| å¤±è´¥ä¸‹è½½ | ${{ steps.download.outputs.failed_downloads || 0 }} ä¸ªæº |" >> $GITHUB_STEP_SUMMARY
          echo "| æ€»è§„åˆ™æ•° | ${{ steps.process.outputs.total_rules || 'éªŒè¯å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ›´æ–°æ—¶é—´ | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "./tmp" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**åŒ…å«è§„åˆ™æº:**" >> $GITHUB_STEP_SUMMARY
            for file in ./tmp/*.txt 2>/dev/null; do
              echo "- $(basename "${file%.*}")" >> $GITHUB_STEP_SUMMARY
            done
          fi

      # ========== æ¸…ç†é˜¶æ®µ ==========
      - name: Cleanup
        if: always()
        run: rm -rf ./tmp
